name: ðŸ› Simplified Debug Build & TestFlight Upload

on:
  push:
    branches:
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
      - 'develop'
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'
  pull_request:
    branches:
      - 'main'
      - 'develop'
    paths-ignore:
      - '**.md'
      - '.github/**'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build (leave empty for current branch)'
        required: false
        default: ''

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  debug-build:
    name: ðŸ—ï¸ Build & Upload Debug Version
    runs-on: macos-14
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ¦ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: ðŸ“± Setup iOS Environment
        run: |
          sudo xcode-select -s /Applications/Xcode_15.3.app/Contents/Developer
          xcodebuild -version

      - name: ðŸ” Setup App Store Connect Authentication
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
        run: |
          # App Store Connect APIã‚­ãƒ¼ã®è¨­å®š
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

      - name: ðŸ“¦ Get Dependencies
        run: |
          flutter pub get
          cd ios && pod install --repo-update

      - name: ðŸ·ï¸ Generate Build Number
        id: build_number
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’æ±ºå®šï¼ˆmanual triggerã€PRã€pushã®é †ã§åˆ¤å®šï¼‰
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch }}"
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          
          # ãƒ–ãƒ©ãƒ³ãƒåã‚’å®‰å…¨ãªå½¢å¼ã«å¤‰æ›
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          
          # ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã®ãƒ“ãƒ«ãƒ‰ç•ªå·
          BUILD_NUMBER=$(date +%Y%m%d%H%M%S)
          
          # ãƒ‡ãƒãƒƒã‚°ç”¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å
          VERSION_NAME="0.1.0-debug-$SAFE_BRANCH"
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "safe_branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          
          echo "ðŸŒ¿ Branch Name: $BRANCH_NAME"
          echo "ðŸ·ï¸ Build Number: $BUILD_NUMBER"
          echo "ðŸ“ Version Name: $VERSION_NAME"

      - name: ðŸ”§ Update Version
        run: |
          # pubspec.yamlã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æ›´æ–°
          sed -i '' "s/version: .*/version: ${{ steps.build_number.outputs.version_name }}+${{ steps.build_number.outputs.build_number }}/" pubspec.yaml
          
          # iOS Info.plistã®è¡¨ç¤ºåã‚’æ›´æ–°ï¼ˆãƒ‡ãƒãƒƒã‚°ç‰ˆã§ã‚ã‚‹ã“ã¨ã‚’æ˜Žç¤ºï¼‰
          /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName 'Chord Book (Debug)'" ios/Runner/Info.plist

      - name: ðŸ—ï¸ Build iOS App with Auto-Signing
        run: |
          flutter build ios \
            --release \
            --build-name="${{ steps.build_number.outputs.version_name }}" \
            --build-number="${{ steps.build_number.outputs.build_number }}"
          
          # Create IPA with automatic signing
          cd ios
          xcodebuild -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath build/Runner.xcarchive \
            -allowProvisioningUpdates \
            archive
          
          xcodebuild -exportArchive \
            -archivePath build/Runner.xcarchive \
            -exportPath build \
            -exportOptionsPlist exportOptions.plist \
            -allowProvisioningUpdates

      - name: ðŸš€ Upload to TestFlight
        run: |
          # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆè‡ªå‹•ç½²åã‚’ä½¿ç”¨ï¼‰
          xcrun altool \
            --upload-app \
            --type ios \
            --file "ios/build/Runner.ipa" \
            --apiKey "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" \
            --apiIssuer "${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}" \
            --verbose

      - name: ðŸ’¾ Store Build Information
        run: |
          # ãƒ“ãƒ«ãƒ‰æƒ…å ±ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
          mkdir -p build_info
          cat > build_info/build_info.json << EOF
          {
            "branch": "${{ steps.build_number.outputs.branch_name }}",
            "commit": "${{ github.sha }}",
            "build_number": "${{ steps.build_number.outputs.build_number }}",
            "version_name": "${{ steps.build_number.outputs.version_name }}",
            "workflow_run_id": "${{ github.run_id }}",
            "event_name": "${{ github.event_name }}",
            "uploaded_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

      - name: ðŸ“¤ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debug-build-${{ steps.build_number.outputs.safe_branch }}-${{ steps.build_number.outputs.build_number }}
          path: |
            build_info/
            ios/build/
          retention-days: 30

      - name: ðŸ“ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const buildNumber = '${{ steps.build_number.outputs.build_number }}';
            const versionName = '${{ steps.build_number.outputs.version_name }}';
            const branch = '${{ steps.build_number.outputs.branch_name }}';
            const eventName = '${{ github.event_name }}';
            
            let comment = `## ðŸ› ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆç°¡æ˜“ç‰ˆï¼‰

            **ãƒ–ãƒ©ãƒ³ãƒ:** \`${branch}\`
            **ãƒãƒ¼ã‚¸ãƒ§ãƒ³:** \`${versionName}\`
            **ãƒ“ãƒ«ãƒ‰ç•ªå·:** \`${buildNumber}\`
            **ãƒˆãƒªã‚¬ãƒ¼:** ${eventName === 'pull_request' ? 'Pull Request' : eventName === 'workflow_dispatch' ? 'æ‰‹å‹•å®Ÿè¡Œ' : 'Push'}
            
            ðŸ“± TestFlightã§ãƒ‡ãƒãƒƒã‚°ç‰ˆã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚
            ã‚¢ãƒ—ãƒªå: **Chord Book (Debug)**
            
            âœ¨ **æ”¹å–„ç‚¹:**
            - å¿…è¦ãªSecretsãŒ3ã¤ã«å‰Šæ¸›ã•ã‚Œã¾ã—ãŸ
            - è‡ªå‹•ç½²åã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒç°¡å˜ã«ãªã‚Šã¾ã—ãŸ
            - è¨¼æ˜Žæ›¸ç®¡ç†ãŒä¸è¦ã«ãªã‚Šã¾ã—ãŸ`;
            
            if (eventName === 'pull_request') {
              comment += '\n\nâš ï¸ ã“ã®ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã¯PRãƒžãƒ¼ã‚¸å¾Œã«è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤
          rm -f ~/.appstoreconnect/private_keys/AuthKey_*.p8