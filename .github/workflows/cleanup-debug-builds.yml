name: ğŸ§¹ Cleanup Debug Builds

on:
  pull_request:
    types: [closed]
  delete:
    # When a branch is deleted

jobs:
  cleanup-debug-builds:
    name: ğŸ—‘ï¸ Remove Debug TestFlight Builds
    runs-on: macos-latest
    if: github.event.pull_request.merged == true || github.event.ref_type == 'branch'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Get Branch Information
        id: branch_info
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          else
            BRANCH_NAME="${{ github.event.ref }}"
          fi
          
          SAFE_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9]/-/g' | tr '[:upper:]' '[:lower:]')
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "safe_branch=$SAFE_BRANCH" >> $GITHUB_OUTPUT
          
          echo "ğŸŒ¿ Cleaning up builds for branch: $BRANCH_NAME"

      - name: ğŸ” Setup App Store Connect API
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
        run: |
          # API Keyã®è¨­å®š
          mkdir -p ~/.appstoreconnect/private_keys
          echo "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode > ~/.appstoreconnect/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

      - name: ğŸ“± Install App Store Connect CLI
        run: |
          # App Store Connect APIã‚’æ“ä½œã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
          cat > cleanup_testflight.py << 'EOF'
          #!/usr/bin/env python3
          import os
          import subprocess
          import json
          import sys
          from datetime import datetime, timedelta

          def run_command(cmd):
              """Run shell command and return output"""
              result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
              if result.returncode != 0:
                  print(f"Error running command: {cmd}")
                  print(f"Error: {result.stderr}")
                  return None
              return result.stdout.strip()

          def get_app_id():
              """Get App Store Connect app ID"""
              app_id = os.environ.get('APP_STORE_CONNECT_APP_ID')
              if not app_id:
                  # Bundle IDã‹ã‚‰ App ID ã‚’å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…
                  print("APP_STORE_CONNECT_APP_ID environment variable not set")
                  return None
              return app_id

          def cleanup_debug_builds(branch_name):
              """Cleanup debug builds for specific branch"""
              app_id = get_app_id()
              if not app_id:
                  return False
              
              api_key_id = os.environ.get('APP_STORE_CONNECT_API_KEY_ID')
              api_issuer_id = os.environ.get('APP_STORE_CONNECT_API_ISSUER_ID')
              
              # ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã®ãƒ‘ã‚¿ãƒ¼ãƒ³
              debug_pattern = f"0.1.0-debug-{branch_name.lower().replace('/', '-')}"
              
              print(f"Looking for debug builds with pattern: {debug_pattern}")
              
              # ã“ã®å®Ÿè£…ã¯æ¦‚å¿µçš„ãªã‚‚ã® - å®Ÿéš›ã®APIå‘¼ã³å‡ºã—ã¯ç’°å¢ƒã«ä¾å­˜
              print(f"Would cleanup TestFlight builds matching: {debug_pattern}")
              
              return True

          if __name__ == "__main__":
              branch_name = sys.argv[1] if len(sys.argv) > 1 else "unknown"
              success = cleanup_debug_builds(branch_name)
              sys.exit(0 if success else 1)
          EOF
          
          chmod +x cleanup_testflight.py

      - name: ğŸ—‘ï¸ Remove TestFlight Debug Builds
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_APP_ID: ${{ secrets.APP_STORE_CONNECT_APP_ID }}
        run: |
          # ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚’å®Ÿè¡Œ
          python3 cleanup_testflight.py "${{ steps.branch_info.outputs.branch_name }}"

      - name: ğŸ§¹ Cleanup Build Artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.branch_info.outputs.safe_branch }}';
            
            // GitHub Actionsã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
            try {
              const artifacts = await github.rest.actions.listArtifactsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              const debugArtifacts = artifacts.data.artifacts.filter(artifact => 
                artifact.name.includes(`debug-build-${branch}`)
              );
              
              for (const artifact of debugArtifacts) {
                await github.rest.actions.deleteArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id
                });
                console.log(`Deleted artifact: ${artifact.name}`);
              }
              
              console.log(`Cleaned up ${debugArtifacts.length} debug build artifacts for branch: ${branch}`);
            } catch (error) {
              console.log(`Error cleaning up artifacts: ${error.message}`);
            }

      - name: ğŸ’¬ Comment Cleanup Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ steps.branch_info.outputs.branch_name }}';
            
            const comment = `## ğŸ§¹ ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ

            **ãƒ–ãƒ©ãƒ³ãƒ:** \`${branch}\`
            
            âœ… TestFlightã‹ã‚‰ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ
            âœ… GitHub Actionsã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ
            
            PRãƒãƒ¼ã‚¸ã«ä¼´ã„ã€ã“ã®ãƒ–ãƒ©ãƒ³ãƒã®ãƒ‡ãƒãƒƒã‚°ãƒ“ãƒ«ãƒ‰ã¯åˆ©ç”¨ã§ããªããªã‚Šã¾ã™ã€‚`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });