# メトロノーム機能実装詳細

## 概要
chord_bookアプリにメトロノーム機能を実装しました。この機能は高精度なタイミング制御と包括的な演奏支援機能を提供します。

## 主な機能

### 高精度タイミング制御
- **BPM範囲**: 30-300 BPM（要件に応じて拡張）
- **精度**: ±1ms以内の精度（metronomeパッケージ使用、フォールバック対応）
- **出力方式**:
  - **音声出力**: 強拍・弱拍区別のクリック音
  - **ビジュアル表示**: 拍インジケーター（強拍は赤、弱拍は青）
  - **ハプティクスフィードバック**: iPhone対応（強拍は重い振動、弱拍は軽い振動）
- **個別設定**: 各出力方式を個別に有効/無効設定可能

### 演奏支援機能
- **拍子記号対応**: 2/4, 3/4, 4/4, 5/4, 6/4, 7/4, 8/4 など
- **強拍・弱拍区別**: 1拍目を強拍として明確に区別
- **タップテンポ機能**: 
  - 最大8回のタップから平均間隔を計算
  - ±1 BPM精度でBPM自動算出
  - タップ履歴のクリア機能
- **カウントイン機能**: 
  - 0-4小節設定可能
  - カウントイン中は専用表示とサウンド
  - 自動的に通常演奏に移行

## 実装詳細

### アーキテクチャ
```
MetronomeScreen (UI)
    ↓
MetronomeViewModel (State Management)
    ↓
MetronomeService (Business Logic)
    ↓
Metronome Package (High-precision timing)
```

### 主要ファイル

#### 1. `lib/models/metronome/metronome_data.dart`
```dart
@freezed
class MetronomeData with _$MetronomeData {
  // BPM, 拍子、状態、出力設定、タップテンポなど全ての状態を管理
  // 強拍判定、カウントイン判定の便利メソッドも提供
}
```

#### 2. `lib/services/metronome_service.dart`
```dart
class MetronomeService {
  // メトロノームパッケージを使用した高精度タイミング制御
  // カウントイン、音声、ハプティクス制御
  // フォールバック機能（Timer-based）
  // タップテンポ計算ロジック
}
```

#### 3. `lib/viewmodels/metronome/metronome_view_model.dart`
```dart
class MetronomeNotifier extends StateNotifier<MetronomeData> {
  // Riverpodを使用した状態管理
  // UI操作からサービスへの橋渡し
  // 30-300 BPMの範囲制限
}
```

#### 4. `lib/views/screens/metronome/metronome_screen.dart`
```dart
class MetronomeScreen extends ConsumerWidget {
  // ユーザーインターフェース
  // BPM表示、拍子表示、各種コントロール
  // 設定ダイアログ（音声・ビジュアル・ハプティクス）
  // タップテンポボタン、カウントイン設定
}
```

### 特殊機能の実装

#### タップテンポアルゴリズム
1. タップ時刻を記録（最大8回）
2. 連続するタップ間隔を計算
3. 平均間隔からBPMを算出: `BPM = 60000 / 平均間隔(ms)`
4. 30-300 BPM範囲内の場合のみ適用

#### カウントイン機能
1. 設定された小節数 × 拍子 = 総カウントイン拍数
2. 専用タイマーでカウントイン実行
3. カウントイン完了後、自動的に通常メトロノーム開始

#### ハプティクスフィードバック
- 強拍: `HapticFeedback.heavyImpact()`
- 弱拍: `HapticFeedback.lightImpact()`
- iOS/Android両対応

## 使用方法

### 基本操作
1. **再生/停止**: 中央の大きな円形ボタン
2. **BPM調整**: +1/-1, +10/-10 ボタンまたはタップテンポ
3. **拍子変更**: 画面下部のドロップダウン
4. **設定**: 右上の歯車アイコンから音声・ビジュアル・ハプティクスの切り替え

### 高度な機能
1. **タップテンポ**: 紫色の「TAP TEMPO」ボタンを楽曲に合わせてタップ
2. **カウントイン**: 設定で1-4小節選択後、オレンジのボタンで開始
3. **個別出力制御**: 設定画面で音声・ビジュアル・ハプティクスを個別制御

## 技術的な特徴

### 依存関係
- `metronome: ^1.0.0` - 高精度タイミング制御
- `flutter_riverpod: ^2.5.1` - 状態管理
- `freezed_annotation: ^2.4.1` - 不変データクラス

### パフォーマンス最適化
- メトロノームパッケージによる高精度制御
- フォールバック機能でデバイス互換性確保
- StreamControllerによる効率的なUI更新

### エラーハンドリング
- メトロノームパッケージ初期化失敗時のTimer-based フォールバック
- BPM範囲制限（30-300）
- 無効な拍子設定の防止

## 今後の拡張可能性

1. **カスタム音声サンプル**: 異なる楽器音でのクリック音
2. **プリセット管理**: よく使用するBPM・拍子の組み合わせ保存
3. **練習モード**: 段階的BPM上昇機能
4. **レコーディング連携**: 演奏録音との同期機能
5. **MIDI連携**: 外部MIDI機器との同期

## テスト

実装された機能は以下の観点でテスト可能です：

1. **基本機能**: 再生/停止、BPM変更、拍子変更
2. **高精度性**: 他のメトロノームアプリとの比較
3. **タップテンポ**: 既知のBPM楽曲でのタップテンポ精度確認
4. **カウントイン**: 各小節数設定での動作確認
5. **出力制御**: 音声・ビジュアル・ハプティクス個別制御